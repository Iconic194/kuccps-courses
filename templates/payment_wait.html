{% extends "base.html" %}

{% block title %}Processing Your Payment{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Processing Modal -->
    <div class="modal fade show" id="processingModal" tabindex="-1" aria-labelledby="processingModalLabel"
        aria-modal="true" data-bs-backdrop="static" data-bs-keyboard="false" style="display: block;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-5">
                    <!-- Processing Spinner -->
                    <div class="mb-4">
                        <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                    </div>

                    <!-- Processing Text -->
                    <h4 class="fw-bold mb-3">Waiting for Payment</h4>
                    <p class="text-muted mb-4" id="statusMessage">STK Push sent to your phone. Please check and enter
                        your M-Pesa PIN to complete payment.</p>

                    <div class="alert alert-warning mb-4">
                        <small>
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>DO NOT REFRESH THIS PAGE</strong> after entering your PIN. The page will update
                            automatically.
                        </small>
                    </div>

                    <!-- Progress Bar -->
                    <div class="progress mb-4" style="height: 6px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                            style="width: 0%" id="progressBar"></div>
                    </div>

                    <!-- Status Timeline -->
                    <div id="statusTimeline" class="small text-muted mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span id="step1">‚è≥ STK Push Sent</span>
                            <span id="step2">‚è≥ Waiting for PIN</span>
                            <span id="step3">‚è≥ Processing</span>
                        </div>
                    </div>

                    <!-- Transaction Info -->
                    {% if transaction_ref %}
                    <div class="mt-3">
                        <small class="text-muted">Transaction ID: <code>{{ transaction_ref }}</code></small>
                    </div>
                    {% endif %}

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 col-8 mx-auto mt-4">
                        <button type="button" class="btn btn-outline-danger" id="cancelProcessing">
                            <i class="fas fa-times me-2"></i>Cancel Payment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Payment wait page loaded - starting payment monitoring');

        const flow = "{{ flow }}";
        const transactionRef = "{{ transaction_ref }}";
        let progress = 0;
        const progressBar = document.getElementById('progressBar');
        const statusMessage = document.getElementById('statusMessage');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');

        let checkCount = 0;
        const maxChecks = 120; // 6 minutes (120 * 3 seconds)

        // Initial progress animation
        const progressInterval = setInterval(() => {
            if (progress < 30) { // Only go to 30% until payment confirmed
                progress += 0.5;
                progressBar.style.width = progress + '%';
            }
        }, 1000);

        // Start checking payment status
        checkPaymentStatus();

        function checkPaymentStatus() {
            checkCount++;
            console.log(`Payment check ${checkCount}/${maxChecks} for flow: ${flow}`);

            fetch(`/check-payment-status/${flow}`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log('Payment status:', data);

                    // üî• ONLY proceed if payment is confirmed AND has M-Pesa receipt
                    if (data.paid === true && data.mpesa_receipt) {
                        console.log('‚úÖ Payment confirmed via MPesa callback with receipt:', data.mpesa_receipt);
                        handlePaymentConfirmed();
                    } else if (data.status === 'pending') {
                        // Payment still pending
                        updatePendingStatus();

                        if (checkCount < maxChecks) {
                            setTimeout(checkPaymentStatus, 3000);
                        } else {
                            handleTimeout('Payment is taking longer than expected. Please check if you completed the payment.');
                        }
                    } else {
                        console.log('Payment not ready yet, status:', data.status);
                        if (checkCount < maxChecks) {
                            setTimeout(checkPaymentStatus, 3000);
                        } else {
                            handleTimeout('Unable to verify payment status. Please try again.');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking payment:', error);
                    if (checkCount < maxChecks) {
                        setTimeout(checkPaymentStatus, 3000);
                    } else {
                        handleTimeout('Network error. Please check your connection and try again.');
                    }
                });
        }

        function updatePendingStatus() {
            // Update status message based on check count
            if (checkCount < 10) {
                statusMessage.textContent = 'STK Push sent. Please check your phone and enter M-Pesa PIN...';
                step1.innerHTML = '‚úÖ STK Push Sent';
                step2.innerHTML = '‚è≥ Waiting for PIN';
            } else if (checkCount < 30) {
                statusMessage.textContent = 'Still waiting for payment confirmation...';
            } else {
                statusMessage.textContent = 'Payment processing is taking longer than usual. Please ensure you entered your PIN.';
            }
        }

        function handlePaymentConfirmed() {
            // Stop initial progress animation
            clearInterval(progressInterval);

            // Update UI for confirmed payment
            statusMessage.innerHTML = '<strong>‚úÖ Payment Confirmed!</strong> Now processing your courses...';
            step2.innerHTML = '‚úÖ PIN Entered';
            step3.innerHTML = '‚è≥ Processing Courses';

            // Speed up progress bar
            const fastProgress = setInterval(() => {
                if (progress < 80) {
                    progress += 2;
                    progressBar.style.width = progress + '%';
                } else {
                    clearInterval(fastProgress);
                    checkCoursesReady();
                }
            }, 200);
        }

        function checkCoursesReady() {
            console.log('Checking if courses are ready...');

            fetch(`/check-courses-ready/${flow}`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log('Courses ready check:', data);

                    if (data.ready) {
                        completeProcessing(data.redirect_url);
                    } else {
                        // Courses not ready yet, check again in 2 seconds
                        setTimeout(checkCoursesReady, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error checking courses:', error);
                    setTimeout(checkCoursesReady, 2000);
                });
        }

        function completeProcessing(redirectUrl) {
            // Complete progress bar
            progress = 100;
            progressBar.style.width = progress + '%';
            progressBar.classList.remove('progress-bar-animated');

            // Update final status
            step3.innerHTML = '‚úÖ Courses Ready';
            statusMessage.innerHTML = '<strong>üéâ All Done!</strong> Redirecting to your results...';

            console.log('Processing complete, redirecting...');

            // Redirect after short delay
            setTimeout(() => {
                if (redirectUrl) {
                    window.location.href = redirectUrl;
                } else {
                    window.location.href = `/results/${flow}`;
                }
            }, 1500);
        }

        function handleTimeout(message) {
            clearInterval(progressInterval);
            statusMessage.innerHTML = `<span class="text-danger">${message}</span>`;
            progressBar.classList.remove('progress-bar-animated');

            // Show retry option
            const cancelBtn = document.getElementById('cancelProcessing');
            cancelBtn.innerHTML = '<i class="fas fa-redo me-2"></i>Try Again';
            cancelBtn.classList.remove('btn-outline-danger');
            cancelBtn.classList.add('btn-primary');
            cancelBtn.onclick = function () {
                window.location.href = `/payment/${flow}`;
            };
        }

        // Handle cancel button
        document.getElementById('cancelProcessing').addEventListener('click', function () {
            if (confirm('Are you sure you want to cancel? If you have already entered your PIN, the payment will still process and you can view results later using "Already Made Payment".')) {
                window.location.href = '/';
            }
        });

        // Prevent modal from closing
        document.getElementById('processingModal').addEventListener('hide.bs.modal', function (e) {
            e.preventDefault();
        });
    });
</script>

<style>
    .modal-content {
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        border: none;
    }

    .modal-body {
        padding: 3rem !important;
    }

    .spinner-border {
        border-width: 4px;
    }

    .progress {
        border-radius: 10px;
        background-color: #f0f0f0;
    }

    .progress-bar {
        border-radius: 10px;
        background: linear-gradient(45deg, #0d6efd, #0dcaf0);
    }

    .alert-warning {
        background-color: #fff3cd;
        border-color: #ffc107;
    }

    #statusTimeline {
        font-size: 0.85em;
    }

    .modal-backdrop {
        opacity: 0.5 !important;
    }

    code {
        background-color: #f8f9fa;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.9em;
    }
</style>
{% endblock %}